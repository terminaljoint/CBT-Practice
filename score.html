<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exam Result - Detailed Analytics</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f9; margin: 0; padding: 40px; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #337ab7; text-align: center; margin-bottom: 30px; }
        
        .score-box { display: flex; justify-content: space-around; background: #337ab7; color: #fff; padding: 20px; border-radius: 6px; margin-bottom: 30px; }
        .stat { text-align: center; }
        .stat-val { font-size: 2em; font-weight: bold; display: block; }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background: #f8f9fa; }

        .review-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .q-circle { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; text-align: center; }
        .correct { background: #dff0d8; border-color: #d6e9c6; color: #3c763d; }
        .wrong { background: #f2dede; border-color: #ebccd1; color: #a94442; }
        .skipped { background: #fcf8e3; border-color: #faebcc; color: #8a6d3b; }

        .btn-home { display: block; width: 200px; margin: 30px auto; padding: 12px; text-align: center; background: #337ab7; color: white; text-decoration: none; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Performance Analysis</h1>

    <div class="score-box" id="mainScore">
        </div>

    <h3>Sectional Breakdown</h3>
    <table id="sectionTable">
        <thead>
            <tr>
                <th>Section</th>
                <th>Total</th>
                <th>Attempted</th>
                <th>Correct</th>
                <th>Incorrect</th>
                <th>Score</th>
            </tr>
        </thead>
        <tbody id="sectionBody"></tbody>
    </table>

    <h3>Question Review</h3>
    <div class="review-grid" id="reviewGrid"></div>

    <a href="index.html" class="btn-home">Retake Exam</a>
</div>

<script>
    const data = JSON.parse(localStorage.getItem("exam_result"));
    if (!data) { window.location.href = "index.html"; }

    const marking = data.marking || { correct: 4, wrong: -1 };
    let totalScore = 0;
    let totalCorrect = 0;
    let totalAttempted = 0;
    let totalQuestions = 0;

    const sections = data.sections;
    const sectionBody = document.getElementById("sectionBody");
    const reviewGrid = document.getElementById("reviewGrid");

    Object.keys(sections).forEach(secName => {
        let secCorrect = 0;
        let secWrong = 0;
        let secAttempted = 0;
        let secQuestions = sections[secName].length;

        sections[secName].forEach((q, i) => {
            totalQuestions++;
            const isAttempted = q.answer !== null && q.answer !== undefined;
            const isCorrect = isAttempted && String(q.answer) === String(q.key);

            // Review Grid Item
            const qDiv = document.createElement("div");
            qDiv.className = "q-circle " + (isAttempted ? (isCorrect ? "correct" : "wrong") : "skipped");
            qDiv.innerHTML = `<b>Q${totalQuestions}</b><br>${isAttempted ? (isCorrect ? "Correct" : "Wrong") : "Skipped"}`;
            reviewGrid.appendChild(qDiv);

            if (isAttempted) {
                secAttempted++;
                if (isCorrect) secCorrect++;
                else secWrong++;
            }
        });

        const secScore = (secCorrect * marking.correct) + (secWrong * marking.wrong);
        totalScore += secScore;
        totalCorrect += secCorrect;
        totalAttempted += secAttempted;

        sectionBody.innerHTML += `
            <tr>
                <td>${secName}</td>
                <td>${secQuestions}</td>
                <td>${secAttempted}</td>
                <td>${secCorrect}</td>
                <td>${secWrong}</td>
                <td><b>${secScore}</b></td>
            </tr>
        `;
    });

    document.getElementById("mainScore").innerHTML = `
        <div class="stat"><span class="stat-val">${totalScore}</span> Total Score</div>
        <div class="stat"><span class="stat-val">${totalCorrect} / ${totalQuestions}</span> Correct</div>
        <div class="stat"><span class="stat-val">${Math.round((totalCorrect/totalAttempted || 0)*100)}%</span> Accuracy</div>
    `;
</script>
</body>
</html>
