<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TerminalJoint Result</title>

<script>
window.MathJax={
tex:{inlineMath:[['$','$'],['\\(','\\)']]}
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" async></script>

<style>
body{font-family:Segoe UI,Arial;background:#f5f5f5;margin:0;padding:20px;}
.container{max-width:1000px;margin:auto;background:#fff;border-radius:10px;overflow:hidden;}
.header{background:#337ab7;color:#fff;padding:25px;text-align:center;}
.meta{margin-top:10px;font-size:13px;}
.stats{display:grid;grid-template-columns:repeat(5,1fr);border-bottom:1px solid #ddd;}
.stat{padding:20px;text-align:center;border-right:1px solid #ddd;}
.stat:last-child{border-right:none;}
.sectionTitle{margin-top:25px;font-weight:bold;color:#337ab7;}
.sol-card{border:1px solid #ddd;margin-top:15px;padding:15px;border-radius:6px;}
.svg-container svg{max-width:100%;}
.correct{color:#16a34a;font-weight:bold;}
.wrong{color:#dc2626;font-weight:bold;}
</style>
</head>

<body>

<div class="container">
<div class="header">
<h2 id="paperName">Result</h2>
<div class="meta" id="paperMeta">Loading...</div>
</div>

<div class="stats">
<div class="stat"><b>Total</b><div id="tq">0</div></div>
<div class="stat"><b>Score</b><div id="ts">0</div></div>
<div class="stat"><b>Accuracy</b><div id="ta">0%</div></div>
<div class="stat"><b>Correct</b><div id="tc">0</div></div>
<div class="stat"><b>Wrong</b><div id="tw">0</div></div>
</div>

<div style="padding:25px;">
<div id="review"></div>
</div>

</div>

<script>

/* ================= LOAD RESULT ================= */

const saved = JSON.parse(localStorage.getItem("exam_result"));
if(!saved){
document.body.innerHTML="No result found";
}

/* ===== VERY IMPORTANT =====
Your CBT engine does NOT save paper name.
So we fetch it from previous page selection.
*/
const paperFile = localStorage.getItem("lastPaper") || "paper-1.json";

/* ================= FETCH PAPER JSON ================= */

fetch(paperFile).then(r=>r.json()).then(paper=>{

document.getElementById("paperName").innerText =
paper.paperName || paperFile.replace(".json","");

const marking = paper.marking || {correct:4,wrong:-1};
document.getElementById("paperMeta").innerText =
`Duration: ${paper.duration} mins | +${marking.correct} / ${marking.wrong}`;

let total=0, correct=0, wrong=0, attempted=0;
let reviewHTML="";

/* ================= MERGE QUESTIONS + USER ANSWERS ================= */

Object.keys(paper.sections).forEach(sec=>{

reviewHTML+=`<div class="sectionTitle">${sec}</div>`;

paper.sections[sec].forEach((q,i)=>{

const userQ = saved.sections[sec][i];
const userAns = userQ.userAnswer;

total++;

let status="Not Attempted";

if(userAns!==null && userAns!==""){
attempted++;

if(String(userAns)===String(q.correct)){
correct++;
status="Correct";
}else{
wrong++;
status="Wrong";
}
}

/* ===== OPTIONS ===== */

let opts="";
if(q.options){
q.options.forEach((op,idx)=>{
let cls="";
if(idx===q.correct) cls="correct";
if(String(userAns)===String(idx) && idx!==q.correct) cls="wrong";
opts+=`<div class="${cls}">${String.fromCharCode(65+idx)}. ${op}</div>`;
});
}

reviewHTML+=`
<div class="sol-card">
<b>Q${i+1}. ${q.q}</b>
${q.svg?`<div class="svg-container">${q.svg}</div>`:""}
${opts}
<div>Status: ${status}</div>
<div><b>Solution:</b> ${q.solution||"No explanation."}</div>
</div>`;

});

});

/* ================= SCORE ================= */

const score=(correct*marking.correct)+(wrong*marking.wrong);

document.getElementById("tq").innerText=total;
document.getElementById("ts").innerText=score.toFixed(2);
document.getElementById("tc").innerText=correct;
document.getElementById("tw").innerText=wrong;
document.getElementById("ta").innerText=
attempted?Math.round((correct/attempted)*100)+"%":"0%";

document.getElementById("review").innerHTML=reviewHTML;

if(window.MathJax) MathJax.typesetPromise();

});
</script>

</body>
</html>
