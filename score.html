<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Performance Report | TerminalJoint</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root { --primary: #337ab7; --success: #5cb85c; --danger: #d9534f; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 25px; margin-bottom: 25px; }
        
        .header-flex { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--primary); padding-bottom: 15px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-top: 20px; }
        .stat-card { background: #f8fafc; padding: 20px; text-align: center; border-radius: 6px; border: 1px solid #e2e8f0; }
        .stat-val { display: block; font-size: 1.8em; font-weight: bold; color: var(--primary); }
        
        /* Question Key Styles */
        .q-item { border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden; }
        .q-item.correct { border-left: 8px solid var(--success); background: #f6ffed; }
        .q-item.wrong { border-left: 8px solid var(--danger); background: #fff1f0; }
        .q-item.skipped { border-left: 8px solid #ccc; background: #fafafa; }
        
        .badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; }
        .badge-success { background: var(--success); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-gray { background: #999; color: white; }

        .solution-box { margin-top: 15px; padding: 15px; background: white; border: 1px dashed #ccc; border-radius: 5px; font-size: 0.95em; }
        svg { max-width: 100%; height: auto; margin: 10px 0; background: white; padding: 5px; border: 1px solid #eee; }
        
        @media print { .no-print { display: none; } }
    </style>
</head>
<body class="tex2jax_ignore">

<div class="container">
    <div class="card header-flex">
        <div>
            <h1 style="margin:0;">Performance Analysis</h1>
            <p id="paperNameDisplay" style="color:#666; margin:5px 0 0;"></p>
        </div>
        <button class="no-print" onclick="window.print()" style="padding:10px 20px; cursor:pointer; background:var(--dark); color:white; border:none; border-radius:4px;">Print Report</button>
    </div>

    <div class="stats-grid" id="overallStats"></div>

    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 25px; margin-top: 25px;">
        <div class="no-print">
            <div class="card">
                <h3>Score Distribution</h3>
                <canvas id="scoreChart"></canvas>
            </div>
            <div class="card" id="violationCard" style="display:none; border: 1px solid var(--danger);">
                <h3 style="color:var(--danger);">Security Log</h3>
                <p id="violationMsg"></p>
            </div>
        </div>

        <div class="tex2jax_process">
            <div class="card">
                <h3>Detailed Answer Key</h3>
                <div id="fullAnswerKey"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const data = JSON.parse(localStorage.getItem("exam_result"));

    if (!data) {
        document.body.innerHTML = "<div class='container'><h1>No Result Found</h1><p>Please complete the exam first.</p></div>";
    } else {
        renderScorePage();
    }

    function renderScorePage() {
        document.getElementById('paperNameDisplay').innerText = data.metadata.paperName;
        
        let totalScore = 0, correctCount = 0, wrongCount = 0, skippedCount = 0, totalQ = 0;
        const sectionLabels = [], sectionScores = [];

        // Handle Violations
        if (data.metadata.violations > 0) {
            const vCard = document.getElementById('violationCard');
            vCard.style.display = 'block';
            document.getElementById('violationMsg').innerHTML = `Candidate detected exiting fullscreen or switching tabs <b>${data.metadata.violations} times</b>. Result may be subject to review.`;
        }

        const keyContainer = document.getElementById('fullAnswerKey');

        Object.keys(data.sections).forEach(secName => {
            let secScore = 0;
            const sectionHeader = document.createElement('h4');
            sectionHeader.style = "background:var(--dark); color:white; padding:10px; margin-top:30px;";
            sectionHeader.innerText = secName.toUpperCase();
            keyContainer.appendChild(sectionHeader);

            data.sections[secName].forEach((q, i) => {
                totalQ++;
                let statusCls = 'skipped';
                let statusText = 'Not Attempted';
                let qScore = 0;

                if (q.userAnswer !== null) {
                    const isCorrect = (q.options) 
                        ? (parseInt(q.userAnswer) === q.correct)
                        : (Math.abs(parseFloat(q.userAnswer) - parseFloat(q.answer)) < 0.01);

                    if (isCorrect) {
                        qScore = data.marking.correct;
                        correctCount++;
                        statusCls = 'correct';
                        statusText = 'Correct';
                    } else {
                        // Numeric questions usually have no negative marking
                        qScore = q.options ? data.marking.wrong : 0;
                        wrongCount++;
                        statusCls = 'wrong';
                        statusText = 'Incorrect';
                    }
                } else {
                    skippedCount++;
                }

                secScore += qScore;

                // Create Question UI
                const qDiv = document.createElement('div');
                qDiv.className = `q-item ${statusCls}`;
                qDiv.innerHTML = `
                    <span class="badge ${statusCls === 'correct' ? 'badge-success' : (statusCls === 'wrong' ? 'badge-danger' : 'badge-gray')}">
                        ${statusText} (${qScore > 0 ? '+' : ''}${qScore})
                    </span>
                    <div style="font-weight:bold; margin-bottom:10px;">Question ${i+1}:</div>
                    <div>${q.q}</div>
                    ${q.svg || ''}
                    <div style="margin-top:15px; font-size:0.95em;">
                        <div style="color:${q.userAnswer === null ? '#666' : 'inherit'}">
                            <b>Your Answer:</b> ${q.userAnswer === null ? 'None' : (q.options ? q.options[q.userAnswer] : q.userAnswer)}
                        </div>
                        <div style="color:var(--success); font-weight:bold; margin-top:5px;">
                            <b>Correct Key:</b> ${q.options ? q.options[q.correct] : q.answer}
                        </div>
                    </div>
                    <div class="solution-box">
                        <b style="color:var(--primary)">Explanation:</b><br>
                        ${q.solution || 'Detailed solution not provided for this question.'}
                    </div>
                `;
                keyContainer.appendChild(qDiv);
            });

            totalScore += secScore;
            sectionLabels.push(secName);
            sectionScores.push(secScore);
        });

        // Overall Stats UI
        document.getElementById('overallStats').innerHTML = `
            <div class="stat-card"><span class="stat-val">${totalScore}</span>Final Score</div>
            <div class="stat-card"><span class="stat-val" style="color:var(--success)">${correctCount}</span>Correct</div>
            <div class="stat-card"><span class="stat-val" style="color:var(--danger)">${wrongCount}</span>Incorrect</div>
            <div class="stat-card"><span class="stat-val" style="color:#666">${skippedCount}</span>Skipped</div>
            <div class="stat-card"><span class="stat-val">${Math.round((totalScore/(totalQ*data.marking.correct))*100)}%</span>Percentage</div>
        `;

        // Charting
        new Chart(document.getElementById('scoreChart'), {
            type: 'bar',
            data: {
                labels: sectionLabels,
                datasets: [{
                    label: 'Marks Obtained',
                    data: sectionScores,
                    backgroundColor: 'rgba(51, 122, 183, 0.6)',
                    borderColor: 'rgba(51, 122, 183, 1)',
                    borderWidth: 1
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });

        // Final MathJax Render
        if (window.MathJax && MathJax.typesetPromise) {
            MathJax.typesetPromise();
        }
    }
</script>

</body>
</html>
