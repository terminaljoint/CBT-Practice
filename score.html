<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Performance Analysis</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { --primary: #337ab7; --success: #5cb85c; --danger: #d9534f; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1, h2, h3 { text-align: center; color: var(--primary); }
        
        /* Dashboard Stats */
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: var(--primary); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card span { font-size: 2.2em; font-weight: bold; display: block; }

        /* Chart Area */
        .chart-container { width: 400px; margin: 0 auto 40px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background: #f8f9fa; }

        /* Solutions Section */
        .solution-box { border: 1px solid #eee; border-left: 5px solid #ccc; padding: 20px; margin-bottom: 20px; border-radius: 4px; background: #fff; }
        .solution-box.correct-border { border-left-color: var(--success); background: #f9fff9; }
        .solution-box.wrong-border { border-left-color: var(--danger); background: #fff9f9; }
        
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: bold; margin-bottom: 10px; }
        .badge-success { background: var(--success); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-warning { background: #f0ad4e; color: white; }

        .sol-text { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd; color: #555; font-style: italic; }
        .btn-print { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; display: block; margin: 20px auto; }
    </style>
</head>
<body>

<div class="container">
    <h1>Exam Result Analysis</h1>

    <div class="dashboard" id="mainDashboard"></div>

    <div class="chart-container">
        <canvas id="performanceChart"></canvas>
    </div>
    

    <h3>Subject-wise Breakdown</h3>
    <table id="sectionalTable">
        <thead>
            <tr>
                <th>Section</th>
                <th>Attempted</th>
                <th>Correct</th>
                <th>Accuracy</th>
                <th>Marks</th>
            </tr>
        </thead>
        <tbody id="sectionalBody"></tbody>
    </table>

    <hr>
    <h2>Question-wise Solutions</h2>
    <div id="solutionsContainer"></div>

    <button class="btn-print" onclick="window.print()">Print Result</button>
</div>

<script>
    const data = JSON.parse(localStorage.getItem("exam_result"));
    if (!data) { alert("No result found!"); window.location.href = "index.html"; }

    const marking = data.marking || { correct: 4, wrong: -1 };
    let totalScore = 0, totalCorrect = 0, totalAttempted = 0, totalQ = 0;
    
    const chartLabels = [];
    const chartData = [];

    const sections = data.sections;
    const solContainer = document.getElementById("solutionsContainer");
    const secBody = document.getElementById("sectionalBody");

    Object.keys(sections).forEach(sec => {
        let sCorr = 0, sWrong = 0, sAtt = 0;
        let sTotal = sections[sec].length;

        sections[sec].forEach((q, i) => {
            totalQ++;
            const isAtt = q.answer !== null && q.answer !== undefined;
            const isCorr = isAtt && String(q.answer) === String(q.key);
            
            if (isAtt) {
                sAtt++; totalAttempted++;
                if (isCorr) { sCorr++; totalCorrect++; }
                else sWrong++;
            }

            // Generate Solution UI
            const box = document.createElement("div");
            box.className = `solution-box ${isAtt ? (isCorr ? 'correct-border' : 'wrong-border') : ''}`;
            
            let statusBadge = `<span class="status-badge badge-warning">Skipped</span>`;
            if (isAtt) {
                statusBadge = isCorr ? `<span class="status-badge badge-success">Correct</span>` : `<span class="status-badge badge-danger">Incorrect</span>`;
            }

            box.innerHTML = `
                ${statusBadge} <strong>Question ${totalQ} (${sec})</strong>
                <div style="margin: 10px 0;">${q.q}</div>
                <div style="font-size: 0.9em;">
                    <p><strong>Your Answer:</strong> ${isAtt ? (q.options ? q.options[q.answer] : q.answer) : 'Not Answered'}</p>
                    <p><strong>Correct Key:</strong> <span style="color:var(--success); font-weight:bold;">${q.options ? q.options[q.key] : q.key}</span></p>
                </div>
                <div class="sol-text">
                    <strong>Solution:</strong><br>
                    ${q.solution || "No detailed solution provided for this question."}
                </div>
            `;
            solContainer.appendChild(box);
        });

        const sScore = (sCorr * marking.correct) + (sWrong * marking.wrong);
        totalScore += sScore;

        chartLabels.push(sec);
        chartData.push(Math.max(0, sScore)); // For Radar Chart

        secBody.innerHTML += `
            <tr>
                <td>${sec}</td>
                <td>${sAtt} / ${sTotal}</td>
                <td>${sCorr}</td>
                <td>${Math.round((sCorr/sAtt || 0)*100)}%</td>
                <td><b>${sScore}</b></td>
            </tr>
        `;
    });

    // Dashboard Update
    document.getElementById("mainDashboard").innerHTML = `
        <div class="stat-card"><span>${totalScore}</span> Total Marks</div>
        <div class="stat-card"><span>${totalCorrect}/${totalQ}</span> Correct</div>
        <div class="stat-card"><span>${Math.round((totalCorrect/totalAttempted || 0)*100)}%</span> Accuracy</div>
    `;

    // Radar Chart Logic
    new Chart(document.getElementById('performanceChart'), {
        type: 'radar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Score per Subject',
                data: chartData,
                backgroundColor: 'rgba(51, 122, 183, 0.2)',
                borderColor: 'rgba(51, 122, 183, 1)',
                pointBackgroundColor: 'rgba(51, 122, 183, 1)'
            }]
        },
        options: { scales: { r: { beginAtZero: true } } }
    });

    // Final LaTeX rendering for solutions
    window.onload = () => { if(window.MathJax) MathJax.typeset(); };
</script>

</body>
</html>
