<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Score Analysis</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root { --primary: #337ab7; --success: #5cb85c; --danger: #d9534f; --bg: #f4f7f9; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1, h2 { text-align: center; color: var(--primary); }
        
        .dashboard { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--primary); color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .stat-card span { font-size: 2.2em; font-weight: bold; display: block; }

        .chart-container { width: 450px; margin: 0 auto 40px; }

        table { width: 100%; border-collapse: collapse; margin-bottom: 40px; font-size: 0.9em; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: center; }
        th { background: #f8f9fa; }

        /* Solution Boxes */
        .solution-box { border: 1px solid #eee; border-left: 5px solid #ccc; padding: 20px; margin-bottom: 25px; border-radius: 4px; background: #fff; position: relative; }
        .correct-border { border-left-color: var(--success); background: #f9fff9; }
        .wrong-border { border-left-color: var(--danger); background: #fff9f9; }
        
        .badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.8em; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; }
        .badge-success { background: var(--success); color: white; }
        .badge-danger { background: var(--danger); color: white; }
        .badge-warning { background: #f0ad4e; color: white; }

        .q-svg { max-width: 300px; height: auto; margin: 15px 0; display: block; background: #fafafa; border: 1px solid #eee; }
        .sol-text { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ddd; color: #666; font-style: italic; }
        
        @media print { .btn-print { display: none; } }
        .btn-print { background: #333; color: white; border: none; padding: 12px 25px; border-radius: 4px; cursor: pointer; display: block; margin: 20px auto; }
    </style>
</head>
<body>

<div class="container">
    <h1>Performance Report</h1>

    <div class="dashboard" id="mainStats"></div>

    <div class="chart-container">
        <canvas id="radarChart"></canvas>
    </div>

    <h3>Subject Breakdown</h3>
    <table id="secTable">
        <thead>
            <tr><th>Subject</th><th>Attempted</th><th>Correct</th><th>Accuracy</th><th>Score</th></tr>
        </thead>
        <tbody id="secBody"></tbody>
    </table>

    <hr>
    <h2>Detailed Solutions</h2>
    <div id="solList"></div>

    <button class="btn-print" onclick="window.print()">Print Result</button>
</div>

<script>
    const examData = JSON.parse(localStorage.getItem("exam_result"));
    if (!examData) { alert("Data not found!"); window.location.href = "index.html"; }

    const marking = examData.marking || { correct: 4, wrong: -1 };
    let totalScore = 0, totalCorrect = 0, totalAtt = 0, qGlobalIdx = 1;

    const chartLabels = [], chartScores = [];
    const solList = document.getElementById("solList");
    const secBody = document.getElementById("secBody");

    Object.keys(examData.sections).forEach(secName => {
        let sCorr = 0, sWrong = 0, sAtt = 0;
        const questions = examData.sections[secName];

        questions.forEach(q => {
            const isNumerical = q.options === undefined;
            const userAns = q.answer; // Set by index.html logic
            const isAttempted = userAns !== null && userAns !== undefined && userAns !== "";
            
            // Checking logic (Index comparison for MCQ, Value comparison for Numerical)
            let isCorrect = false;
            if (isAttempted) {
                sAtt++; totalAtt++;
                if (isNumerical) {
                    isCorrect = parseFloat(userAns) === parseFloat(q.answer);
                } else {
                    isCorrect = String(userAns) === String(q.correct);
                }
                
                if (isCorrect) { sCorr++; totalCorrect++; }
                else sWrong++;
            }

            // Create Solution Card
            const card = document.createElement("div");
            card.className = `solution-box ${isAttempted ? (isCorrect ? 'correct-border' : 'wrong-border') : ''}`;
            
            let status = `<span class="badge badge-warning">Skipped</span>`;
            if (isAttempted) status = isCorrect ? `<span class="badge badge-success">Correct</span>` : `<span class="badge badge-danger">Incorrect</span>`;

            // Display Answer strings
            let displayUser = "Not Answered";
            let displayCorrect = isNumerical ? q.answer : q.options[q.correct];
            if (isAttempted) {
                displayUser = isNumerical ? userAns : q.options[userAns];
            }

            card.innerHTML = `
                ${status} <strong>Question ${qGlobalIdx++} (${secName})</strong>
                <div style="margin-top:10px;">${q.q}</div>
                ${q.svg ? `<div class="q-svg">${q.svg}</div>` : ''}
                <div style="font-size:0.9em; margin-top:10px;">
                    <p><strong>Your Response:</strong> ${displayUser}</p>
                    <p><strong>Correct Answer:</strong> <span style="color:var(--success); font-weight:bold;">${displayCorrect}</span></p>
                </div>
                <div class="sol-text"><strong>Explanation:</strong> ${q.solution || 'N/A'}</div>
            `;
            solList.appendChild(card);
        });

        const sScore = (sCorr * marking.correct) + (sWrong * marking.wrong);
        totalScore += sScore;

        chartLabels.push(secName);
        chartScores.push(sScore);

        secBody.innerHTML += `
            <tr>
                <td>${secName}</td>
                <td>${sAtt} / ${questions.length}</td>
                <td>${sCorr}</td>
                <td>${sAtt > 0 ? Math.round((sCorr/sAtt)*100) : 0}%</td>
                <td><strong>${sScore}</strong></td>
            </tr>
        `;
    });

    // Top Dashboard
    document.getElementById("mainStats").innerHTML = `
        <div class="stat-card"><span>${totalScore}</span> Final Score</div>
        <div class="stat-card"><span>${totalCorrect}</span> Correct</div>
        <div class="stat-card"><span>${totalAtt > 0 ? Math.round((totalCorrect/totalAtt)*100) : 0}%</span> Accuracy</div>
    `;

    // Radar Chart
    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Score Analysis',
                data: chartScores,
                backgroundColor: 'rgba(51, 122, 183, 0.2)',
                borderColor: 'rgba(51, 122, 183, 1)',
                pointBackgroundColor: 'rgba(51, 122, 183, 1)'
            }]
        },
        options: { scales: { r: { beginAtZero: true } } }
    });

    // Run MathJax
    window.onload = () => { if(window.MathJax) MathJax.typeset(); };
</script>

</body>
</html>
