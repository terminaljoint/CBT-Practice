<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exam Audit & Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #004ba0; }
        .incorrect { color: #c62828; } .correct { color: #2e7d32; }
        .q-row { border-bottom: 1px solid #eee; padding: 10px 0; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Performance Analysis</h1>
        <div class="grid" id="mainStats"></div>
    </div>

    <div class="card" style="max-width: 500px; margin: auto;">
        <canvas id="radarChart"></canvas>
    </div>

    

    <div class="card" id="auditLog">
        <h3>Security Log</h3>
        <p id="violationCount" style="color:red;"></p>
    </div>

    <div class="card" id="review"></div>

<script>
    const res = JSON.parse(localStorage.getItem("result"));
    if(!res) { document.body.innerHTML = "No Session Found"; }

    let tScore = 0, tCorr = 0, tAtt = 0, tQ = 0;
    const labels = [], scores = [];

    Object.keys(res.sections).forEach(s => {
        let sScore = 0;
        const div = document.createElement('div');
        div.innerHTML = `<h3>${s}</h3>`;
        
        res.sections[s].forEach(q => {
            tQ++;
            const isMcq = q.options !== undefined;
            const isCorr = isMcq ? (parseInt(q.user) === q.correct) : (parseFloat(q.user) === parseFloat(q.answer));
            
            if(q.user !== null) {
                tAtt++;
                if(isCorr) { sScore += 4; tCorr++; } else { sScore -= 1; }
            }
            
            const row = document.createElement('div');
            row.className = 'q-row';
            row.innerHTML = `<span class="${isCorr?'correct':'incorrect'}">${isCorr?'✔':'✘'}</span> ${q.q}`;
            div.appendChild(row);
        });
        
        tScore += sScore;
        labels.push(s);
        scores.push(sScore);
        document.getElementById('review').appendChild(div);
    });

    document.getElementById('mainStats').innerHTML = `
        <div><div class="stat-val">${tScore}</div>Score</div>
        <div><div class="stat-val">${Math.round(tCorr/tAtt*100)||0}%</div>Accuracy</div>
        <div><div class="stat-val">${tAtt}/${tQ}</div>Attempted</div>
        <div><div class="stat-val">${tCorr}</div>Correct</div>
    `;

    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{ label: 'Performance', data: scores, backgroundColor: 'rgba(0,75,160,0.2)' }]
        }
    });
</script>
</body>
</html>
