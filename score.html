<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Exam Audit & Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .stat-val { font-size: 1.8rem; font-weight: bold; color: #004ba0; }
        .incorrect { color: #d32f2f; background: #ffebee; }
        .correct { color: #2e7d32; background: #e8f5e9; }
        .unattempted { color: #757575; background: #f5f5f5; }
        .q-row { border-left: 5px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .q-row.correct { border-left-color: #2e7d32; }
        .q-row.incorrect { border-left-color: #d32f2f; }
        .sol-box { margin-top: 10px; font-size: 0.9rem; font-style: italic; color: #555; border-top: 1px dashed #ccc; padding-top: 5px; }
        svg { width: 150px; display: block; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="card">
        <h1>Performance Analysis</h1>
        <div class="grid" id="mainStats"></div>
    </div>

    <div style="display:flex; gap:20px">
        <div class="card" style="flex:1"><canvas id="radarChart"></canvas></div>
        <div class="card" style="flex:2" id="review"><h2>Question Review</h2></div>
    </div>

<script>
    const res = JSON.parse(localStorage.getItem("result"));
    if(!res) { document.body.innerHTML = "<h1>No Session Found</h1>"; }

    let tScore = 0, tCorr = 0, tAtt = 0, tQ = 0;
    const labels = [], scores = [];

    Object.keys(res.sections).forEach(s => {
        let sScore = 0;
        const div = document.createElement('div');
        div.innerHTML = `<h3>Section: ${s}</h3>`;
        
        res.sections[s].forEach((q, idx) => {
            tQ++;
            let isCorr = false;
            let statusClass = 'unattempted';

            if(q.user !== null) {
                tAtt++;
                // Type Checking: MCQ (correct index) vs Numeric (answer value)
                if(q.options) {
                    isCorr = (parseInt(q.user) === q.correct);
                } else {
                    isCorr = (parseFloat(q.user) === parseFloat(q.answer));
                }

                if(isCorr) { 
                    sScore += res.marking.correct; 
                    tCorr++; 
                    statusClass = 'correct';
                } else { 
                    // Assume negative marking only for MCQs as per standard NTA
                    sScore += q.options ? res.marking.wrong : 0; 
                    statusClass = 'incorrect';
                }
            }
            
            const row = document.createElement('div');
            row.className = `q-row ${statusClass}`;
            row.innerHTML = `
                <strong>Q${idx+1}:</strong> ${q.q}
                ${q.svg || ''}
                <div style="margin:5px 0">
                    Your: <b>${q.user === null ? 'Skipped' : (q.options ? q.options[q.user] : q.user)}</b> | 
                    Correct: <b>${q.options ? q.options[q.correct] : q.answer}</b>
                </div>
                <div class="sol-box"><b>Solution:</b> ${q.solution || 'Direct answer.'}</div>
            `;
            div.appendChild(row);
        });
        
        tScore += sScore;
        labels.push(s);
        scores.push(sScore);
        document.getElementById('review').appendChild(div);
    });

    document.getElementById('mainStats').innerHTML = `
        <div><div class="stat-val">${tScore}</div>Score</div>
        <div><div class="stat-val">${Math.round(tCorr/tAtt*100)||0}%</div>Accuracy</div>
        <div><div class="stat-val">${tAtt}/${tQ}</div>Attempted</div>
        <div><div class="stat-val">${tCorr}</div>Correct</div>
    `;

    new Chart(document.getElementById('radarChart'), {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{ label: 'Sectional Score', data: scores, backgroundColor: 'rgba(0,75,160,0.2)', borderColor: '#004ba0' }]
        },
        options: { scales: { r: { beginAtZero: true } } }
    });
</script>
</body>
</html>
