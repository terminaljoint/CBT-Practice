<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBT-Practice | Exam Interface</title>

    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        :root {
            --primary: #0b3d91;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --review: #8e44ad;
            --bg: #eef2f7;
        }

        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); user-select: none; }

        /* ===== START SCREEN ===== */
        .startScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 999; }
        .startCard { background: #fff; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        select { width: 100%; padding: 10px; margin: 15px 0; border-radius: 5px; border: 1px solid #ccc; }

        /* ===== HEADER ===== */
        .header { background: var(--primary); color: #fff; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ===== LAYOUT ===== */
        .container { display: flex; height: calc(100vh - 60px); }
        .left { width: 75%; padding: 25px; overflow-y: auto; display: flex; flex-direction: column; }
        .right { width: 25%; background: #fff; border-left: 1px solid #ddd; padding: 20px; display: flex; flex-direction: column; }

        .qheader { font-weight: bold; font-size: 1.1em; margin-bottom: 15px; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 5px; }

        /* ===== OPTIONS ===== */
        .option { display: block; margin: 12px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9; cursor: pointer; transition: 0.2s; }
        .option:hover { background: #f0f4ff; border-color: var(--primary); }
        .numInput { width: 200px; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 6px; outline: none; }
        .numInput:focus { border-color: var(--primary); }

        /* ===== TABS ===== */
        .tabs button { margin-right: 8px; margin-bottom: 15px; padding: 8px 16px; border: none; border-radius: 4px; background: #ddd; cursor: pointer; font-weight: 600; }
        .tabActive { background: var(--primary) !important; color: #fff; }

        /* ===== NAV BUTTONS ===== */
        .cbtNav { margin-top: auto; padding-top: 20px; display: flex; justify-content: space-between; }
        .cbtNav button { padding: 10px 20px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; font-weight: bold; }
        .btn-next { background: var(--success); color: white; border: none !important; }
        .btn-review { background: var(--warning); color: white; border: none !important; }

        /* ===== PALETTE & LEGEND ===== */
        .legend { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; }
        .leg-item { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 2px; }

        .palette { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; overflow-y: auto; }
        .palette button { width: 45px; height: 40px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; }

        /* Status Classes */
        .notVisited { background: #eee; color: #333; }
        .notAnswered { background: var(--danger); color: #fff; }
        .answered { background: var(--success); color: #fff; }
        .review { background: var(--warning); color: #fff; }
        .reviewAnswered { background: var(--review); color: #fff; position: relative; }
        .reviewAnswered::after { content: "âœ“"; position: absolute; top: -2px; right: 2px; font-size: 10px; }
        .current { outline: 3px solid #333; outline-offset: -3px; }

        .submitBtn { background: var(--primary); color: #fff; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 20px; }

        .diagram { max-width: 100%; margin: 20px 0; text-align: center; }
        .diagram svg { max-height: 300px; }
    </style>
</head>

<body>

<div id="startScreen" class="startScreen">
    <div class="startCard">
        <h2>CBT Assessment</h2>
        <p>Select your paper to begin</p>
        <select id="paperSelect"></select>
        <div id="paperInfo" style="font-size: 0.9em; color: #666; margin-bottom: 20px;"></div>
        <button onclick="startExam()" style="width:100%; padding:12px; background:var(--primary); color:white; border:none; border-radius:5px; cursor:pointer;">Start Examination</button>
    </div>
</div>

<div class="header">
    <div><strong>EXAM MODE</strong></div>
    <div>Time Left: <span id="time" style="font-family: monospace; font-size: 1.2em;">00:00:00</span></div>
</div>

<div class="container">
    <div class="left">
        <div class="tabs" id="tabs"></div>
        <div class="qheader" id="qno"></div>
        <div id="question" style="font-size: 1.1em; line-height: 1.5;"></div>
        <div id="options"></div>

        <div class="cbtNav">
            <div>
                <button onclick="clearResponse()">Clear Response</button>
                <button class="btn-review" onclick="markReviewNext()">Mark for Review & Next</button>
            </div>
            <div>
                <button onclick="prevQ()">Previous</button>
                <button class="btn-next" onclick="nextQ()">Save & Next</button>
            </div>
        </div>
    </div>

    <div class="right">
        <b>Question Palette</b>
        <div class="legend">
            <div class="leg-item"><span class="dot" style="background:#eee"></span> Not Visited</div>
            <div class="leg-item"><span class="dot" style="background:var(--danger)"></span> Not Answered</div>
            <div class="leg-item"><span class="dot" style="background:var(--success)"></span> Answered</div>
            <div class="leg-item"><span class="dot" style="background:var(--warning)"></span> Review</div>
            <div class="leg-item" style="grid-column: span 2;"><span class="dot" style="background:var(--review)"></span> Answered & Marked for Review</div>
        </div>
        <hr>
        <div id="palette" class="palette"></div>
        <button class="submitBtn" onclick="submitExam()">Submit Test</button>
    </div>
</div>

<script>
const PAPER_LIST = ["paper-1.json", "AEEE FE-1.json", "tough-jee.json"];
const paperSelect = document.getElementById("paperSelect");
paperSelect.innerHTML = PAPER_LIST.map(p => `<option value="${p}">${p}</option>`).join("");

let examData, sections, currentSection, index = 0, totalTime = 0, started = false;

paperSelect.onchange = loadPaperInfo;
loadPaperInfo();

function loadPaperInfo() {
    fetch(paperSelect.value).then(r => r.json()).then(data => {
        let totalQ = Object.values(data.sections).reduce((a, b) => a + b.length, 0);
        document.getElementById("paperInfo").innerHTML = `
            <b>Duration:</b> ${data.duration} mins | <b>Questions:</b> ${totalQ}<br>
            <b>Marking:</b> +${data.marking.correct} / ${data.marking.wrong}
        `;
    }).catch(e => document.getElementById("paperInfo").innerText = "Error loading paper details.");
}

function startExam() {
    fetch(paperSelect.value).then(r => r.json()).then(data => {
        examData = data;
        sections = data.sections;
        totalTime = data.duration * 60;

        Object.keys(sections).forEach(sec => {
            sections[sec] = sections[sec].map(q => ({
                ...q, answer: null, review: false, visited: false
            }));
        });

        currentSection = Object.keys(sections)[0];
        document.getElementById("startScreen").style.display = "none";
        started = true;
        buildTabs();
        render();
        startTimer();
    });
}

function buildTabs() {
    document.getElementById("tabs").innerHTML = Object.keys(sections).map(sec => 
        `<button id="tab_${sec}" onclick="switchSection('${sec}')">${sec}</button>`
    ).join("");
    updateActiveTab();
}

function updateActiveTab() {
    Object.keys(sections).forEach(sec => document.getElementById("tab_" + sec).classList.remove("tabActive"));
    document.getElementById("tab_" + currentSection).classList.add("tabActive");
}

function switchSection(sec) {
    currentSection = sec;
    index = 0;
    updateActiveTab();
    render();
}

function render() {
    const q = sections[currentSection][index];
    if(!q.visited) q.visited = true;

    document.getElementById("qno").innerText = `${currentSection} - Question ${index + 1}`;
    
    let html = q.q || "";
    if (q.svg) html += `<div class="diagram">${q.svg}</div>`;
    document.getElementById("question").innerHTML = html;

    const optCont = document.getElementById("options");
    if (q.options) {
        optCont.innerHTML = q.options.map((op, i) => `
            <label class="option">
                <input type="radio" name="qopt" ${q.answer === i ? "checked" : ""} onchange="selectOption(${i})">
                ${op}
            </label>`).join("");
    } else {
        optCont.innerHTML = `<div style="margin:20px 0;">Enter Answer: <br><br>
            <input type="number" step="any" class="numInput" value="${q.answer ?? ''}" oninput="setNumerical(this.value)"></div>`;
    }

    updatePalette();
    MathJax.typesetPromise();
}

function selectOption(i) {
    sections[currentSection][index].answer = i;
    updatePalette();
}

function setNumerical(v) {
    sections[currentSection][index].answer = v === "" ? null : parseFloat(v);
    updatePalette();
}

function clearResponse() {
    sections[currentSection][index].answer = null;
    sections[currentSection][index].review = false;
    render();
}

function markReviewNext() {
    sections[currentSection][index].review = true;
    nextQ();
}

function nextQ() {
    if (index < sections[currentSection].length - 1) {
        index++;
        render();
    }
}

function prevQ() {
    if (index > 0) {
        index--;
        render();
    }
}

function gotoQ(i) {
    index = i;
    render();
}

function updatePalette() {
    document.getElementById("palette").innerHTML = sections[currentSection].map((q, i) => {
        let cls = "notVisited";
        if (q.visited) cls = "notAnswered";
        if (q.answer !== null) cls = "answered";
        
        // Review Logic
        if (q.review) {
            cls = (q.answer !== null) ? "reviewAnswered" : "review";
        }
        
        if (i === index) cls += " current";
        return `<button class="${cls}" onclick="gotoQ(${i})">${i + 1}</button>`;
    }).join("");
}

function startTimer() {
    const timerInt = setInterval(() => {
        if (!started) return;
        totalTime--;
        let h = Math.floor(totalTime / 3600);
        let m = Math.floor((totalTime % 3600) / 60);
        let s = totalTime % 60;
        document.getElementById("time").innerText = 
            `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;

        if (totalTime <= 0) {
            clearInterval(timerInt);
            alert("Time Up!");
            submitExam(true);
        }
    }, 1000);
}

// Keyboard Support
document.addEventListener('keydown', (e) => {
    if (!started) return;
    if (e.key === "ArrowRight") nextQ();
    if (e.key === "ArrowLeft") prevQ();
});

function submitExam(auto = false) {
    let unanswered = 0;
    Object.values(sections).forEach(arr => {
        arr.forEach(q => { if (q.answer === null) unanswered++; });
    });

    if (!auto && !confirm(`You have ${unanswered} unanswered questions. Submit test?`)) return;

    localStorage.setItem("exam_result", JSON.stringify(examData));
    location.href = "score.html";
}

window.onbeforeunload = function() { if(started) return "Progress will be lost!"; };
</script>

</body>
</html>
