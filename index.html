<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CBT-Practice</title>

<script>
window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>

body{
margin:0;
font-family:Arial,Helvetica,sans-serif;
background:#eef2f7;
user-select:none;
}

.header{
background:#0b3d91;
color:#fff;
padding:10px 16px;
display:flex;
justify-content:space-between;
align-items:center;
}

.ribbon{
background:#fff;
padding:10px 14px;
border-bottom:2px solid #ddd;
font-size:14px;
}

.container{
display:flex;
height:calc(100vh - 110px);
}

.left{
width:72%;
padding:20px;
overflow:auto;
}

.right{
width:28%;
background:#fff;
border-left:2px solid #ddd;
padding:12px;
overflow:auto;
}

.qheader{
position:sticky;
top:0;
background:#eef2f7;
padding:8px 0;
font-weight:bold;
}

.option{
display:block;
margin:10px 0;
padding:12px;
border:1px solid #ccc;
border-radius:6px;
background:#fff;
cursor:pointer;
}

.tabs button{
margin-right:6px;
margin-bottom:8px;
padding:6px 12px;
cursor:pointer;
border:none;
border-radius:4px;
background:#ddd;
}

.tabActive{
background:#0b3d91;
color:#fff;
}

/* ===== HARD NAV BAR ===== */

.cbtNav{
position:relative;
width:100%;
height:60px;
margin-top:20px;
}

.navLeft{
position:absolute;
left:0;
top:0;
}

.navCenter{
position:absolute;
left:50%;
transform:translateX(-50%);
top:0;
}

.navLeft button,
.navCenter button{
margin-right:10px;
padding:6px 12px;
}

/* ===== PALETTE COLORS (REAL CBT) ===== */

.palette{
display:grid;
grid-template-columns:repeat(5,1fr);
gap:6px;
}

.palette button{
width:40px;
height:40px;
border:none;
border-radius:4px;
cursor:pointer;
font-weight:bold;
}

.notVisited{background:#ccc;}
.notAnswered{background:#e74c3c;color:#fff;}   /* RED */
.answered{background:#2ecc71;color:#fff;}      /* GREEN */
.review{background:#f39c12;color:#fff;}        /* ORANGE */
.reviewAnswered{background:#8e44ad;color:#fff;}/* PURPLE */
.current{outline:3px solid #0b3d91;}

.submitBtn{
background:#0b3d91;
color:#fff;
padding:8px 18px;
border:none;
border-radius:4px;
cursor:pointer;
font-weight:bold;
width:100%;
margin-top:10px;
}

.legend div{
margin:4px 0;
font-size:13px;
}

</style>
</head>

<body>

<div class="header">
<div><b>CBT-Practice</b></div>
<div>
Paper:
<select id="paperSelect"></select>
&nbsp;&nbsp;
Time Left:
<b><span id="time">00:00</span></b>
</div>
</div>

<div class="ribbon" id="stats"></div>

<div class="container">

<div class="left">

<div class="tabs" id="tabs"></div>

<div class="qheader" id="qno"></div>

<div id="question"></div>
<div id="options"></div>

<div class="cbtNav">

<div class="navLeft">
<button onclick="clearResponse()">Clear Response</button>
<button onclick="markReview()">Mark for Review</button>
</div>

<div class="navCenter">
<button onclick="prevQ()">Previous</button>
<button onclick="nextQ()">Save & Next</button>
</div>

</div>

</div>

<div class="right">

<b>Question Palette</b>
<hr>

<div id="palette" class="palette"></div>

<button class="submitBtn" onclick="submitExam()">Submit Test</button>

<hr>

<div class="legend">
<div><span style="background:#ccc;padding:4px 8px;"> </span> Not Visited</div>
<div><span style="background:#e74c3c;color:#fff;padding:4px 8px;"> </span> Not Answered</div>
<div><span style="background:#2ecc71;color:#fff;padding:4px 8px;"> </span> Answered</div>
<div><span style="background:#f39c12;color:#fff;padding:4px 8px;"> </span> Review</div>
<div><span style="background:#8e44ad;color:#fff;padding:4px 8px;"> </span> Review + Answered</div>
</div>

</div>

</div>

<script>

const PAPER_LIST=["paper-1.json","paper-2.json","paper-3.json"];

const params=new URLSearchParams(location.search);
let selectedPaper=params.get("paper")||PAPER_LIST[0];

paperSelect.innerHTML=PAPER_LIST.map(p=>
`<option value="${p}" ${p===selectedPaper?"selected":""}>${p}</option>`
).join("");

paperSelect.onchange=()=>{
location.href="index.html?paper="+paperSelect.value;
};

let examData,sections;
let currentSection,index=0;
let sectionIndexMemory={};
let totalTime=0;
let timerStarted=false;

fetch(selectedPaper)
.then(r=>r.json())
.then(data=>initExam(data));

function initExam(data){

examData=data;
sections=data.sections;
totalTime=data.duration*60;

Object.keys(sections).forEach(sec=>{
sections[sec]=sections[sec].map(q=>({
...q,answer:null,review:false,visited:false
}));
});

currentSection=Object.keys(sections)[0];

buildTabs();
render();
startTimer();
}

function buildTabs(){
tabs.innerHTML=Object.keys(sections)
.map(sec=>`<button id="tab_${sec}" onclick="switchSection('${sec}')">${sec}</button>`)
.join("");
updateActiveTab();
}

function updateActiveTab(){
Object.keys(sections).forEach(sec=>{
document.getElementById("tab_"+sec).classList.remove("tabActive");
});
document.getElementById("tab_"+currentSection).classList.add("tabActive");
}

function switchSection(sec){
sectionIndexMemory[currentSection]=index;
currentSection=sec;
index=sectionIndexMemory[sec]??0;
updateActiveTab();
render();
}

function render(){

document.querySelector(".left").scrollTop=0;

const q=sections[currentSection][index];
q.visited=true;

qno.innerText=currentSection+" - Question "+(index+1);
question.innerHTML=q.q;

options.innerHTML=q.options.map((op,i)=>`
<label class="option">
<input type="radio" name="opt"
${q.answer===i?"checked":""}
onchange="selectOption(${i})">
${op}
</label>`).join("");

updatePalette();
updateStats();

MathJax.typesetPromise([document.getElementById("question")]);
}

function selectOption(i){
sections[currentSection][index].answer=i;
sections[currentSection][index].review=false;
updatePalette();updateStats();
}

function clearResponse(){
sections[currentSection][index].answer=null;
render();
}

function markReview(){
sections[currentSection][index].review^=true;
updatePalette();updateStats();
}

function nextQ(){ if(index<sections[currentSection].length-1){index++;render();}}
function prevQ(){ if(index>0){index--;render();}}
function gotoQ(i){index=i;render();}

/* ===== UPDATED CBT COLOR LOGIC ===== */

function updatePalette(){
palette.innerHTML=sections[currentSection].map((q,i)=>{

let cls="notVisited";

if(q.visited && q.answer===null && !q.review) cls="notAnswered";
if(q.answer!==null && !q.review) cls="answered";
if(q.review && q.answer===null) cls="review";
if(q.review && q.answer!==null) cls="reviewAnswered";

if(i===index) cls+=" current";

return `<button class="${cls}" onclick="gotoQ(${i})">${i+1}</button>`;
}).join("");
}

function updateStats(){

let nv=0,na=0,ans=0,rev=0,ra=0;

sections[currentSection].forEach(q=>{
if(!q.visited)nv++;
if(q.visited && q.answer===null && !q.review)na++;
if(q.answer!==null&&!q.review)ans++;
if(q.review&&q.answer===null)rev++;
if(q.review&&q.answer!==null)ra++;
});

stats.innerHTML=
`Not Visited: <b>${nv}</b> |
Not Answered: <b>${na}</b> |
Answered: <b>${ans}</b> |
Review: <b>${rev}</b> |
Review+Answered: <b>${ra}</b>`;
}

function startTimer(){

if(timerStarted) return;
timerStarted=true;

setInterval(()=>{

totalTime--;

if(totalTime<=0){
submitExam(true);
return;
}

let m=Math.floor(totalTime/60);
let s=totalTime%60;

time.innerText=
String(m).padStart(2,'0')+":"+
String(s).padStart(2,'0');

},1000);
}

function submitExam(auto=false){

if(!auto){
if(!confirm("Submit CBT-Practice Test?\nYou cannot return once submitted."))return;
}

localStorage.setItem("exam_result",JSON.stringify(examData));
location.href="score.html";
}

</script>
</body>
</html>
