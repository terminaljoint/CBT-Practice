<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CBT-Practice</title>

<script>
window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>

body{
margin:0;
font-family:Arial,Helvetica,sans-serif;
background:#eef2f7;
user-select:none;
}

.header{
background:#0b3d91;
color:#fff;
padding:10px 16px;
display:flex;
justify-content:space-between;
align-items:center;
}

.container{display:flex;height:calc(100vh - 110px);}
.left{width:72%;padding:20px;overflow:auto;}
.right{width:28%;background:#fff;border-left:2px solid #ddd;padding:12px;height:100vh;overflow:auto;}

.qheader{font-weight:bold;margin-bottom:10px;}

.option{
display:block;margin:10px 0;padding:12px;
border:1px solid #ccc;border-radius:6px;background:#fff;
cursor:pointer;
}

.option:hover{background:#eaf1ff;}

.numInput{
width:220px;padding:10px;font-size:16px;
border:1px solid #ccc;border-radius:6px;
}

.palette{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;}

.palette button{
width:40px;height:40px;border:none;border-radius:4px;font-weight:bold;
}

.notVisited{background:#ccc;}
.answered{background:#2ecc71;color:#fff;}
.current{box-shadow:0 0 0 3px #0b3d91 inset;}

.submitBtn{
background:#0b3d91;color:#fff;padding:8px 18px;
border:none;border-radius:4px;font-weight:bold;width:100%;margin-top:10px;
}

.diagram{
max-width:420px;margin:12px auto;padding:8px;background:#fff;
border:1px solid #ddd;border-radius:6px;text-align:center;
}

.diagram svg{width:100%;height:auto;}

/* ===== START SCREEN ===== */

.startScreen{
position:fixed;
top:0;left:0;width:100%;height:100%;
background:#eef2f7;
display:flex;
align-items:center;
justify-content:center;
z-index:999;
}

.startCard{
background:#fff;
padding:20px;
border-radius:8px;
width:360px;
box-shadow:0 0 10px rgba(0,0,0,0.15);
text-align:center;
}

</style>
</head>

<body>

<!-- ===== START CONFIRM SCREEN ===== -->

<div id="startScreen" class="startScreen">
<div class="startCard">
<h3 id="paperTitle">Loading...</h3>
<div id="paperInfo"></div>
<br>
<button onclick="startExam()">Start Test</button>
</div>
</div>

<div class="header">
<div><b>CBT-Practice</b></div>
<div>
Paper:
<select id="paperSelect"></select>
Time Left:
<b><span id="time">00:00</span></b>
</div>
</div>

<div class="container">

<div class="left">
<div class="qheader" id="qno"></div>
<div id="question"></div>
<div id="options"></div>
<button onclick="prevQ()">Previous</button>
<button onclick="nextQ()">Save & Next</button>
</div>

<div class="right">
<b>Question Palette</b><hr>
<div id="palette" class="palette"></div>
<button class="submitBtn" onclick="submitExam()">Submit Test</button>
</div>

</div>

<script>

/* ===== PAPER SYSTEM ===== */

const PAPER_LIST=["paper-1.json","AEEE FE-1.json","tough-jee.json"];

const params=new URLSearchParams(location.search);
let selectedPaper=params.get("paper")||PAPER_LIST[0];

paperSelect.innerHTML=PAPER_LIST.map(p=>
`<option value="${p}" ${p===selectedPaper?"selected":""}>${p}</option>`
).join("");

paperSelect.onchange=()=>{
location.href="index.html?paper="+paperSelect.value;
};

let examData,sections,currentSection,index=0,totalTime=0;
let started=false;

/* ===== LOAD PAPER ===== */

fetch(selectedPaper)
.then(r=>r.json())
.then(data=>{
if(!data.sections){
alert("Invalid Paper Format");
return;
}
examData=data;
sections=data.sections;

let totalQ=Object.values(sections).reduce((a,b)=>a+b.length,0);

paperTitle.innerText=selectedPaper;
paperInfo.innerHTML=`
Duration: ${data.duration} minutes<br>
Questions: ${totalQ}<br>
Marking: +${data.marking.correct} / ${data.marking.wrong}
`;
});

/* ===== START EXAM ===== */

function startExam(){

started=true;
startScreen.style.display="none";

totalTime=examData.duration*60;

Object.keys(sections).forEach(sec=>{
sections[sec]=sections[sec].map(q=>({...q,answer:null,visited:false}));
});

currentSection=Object.keys(sections)[0];
render();
startTimer();
}

/* ===== PREVENT EXIT ===== */

window.onbeforeunload=function(){
if(started) return "Progress may be lost.";
};

/* ===== RENDER ===== */

function render(){

const q=sections[currentSection][index];
q.visited=true;

qno.innerText=currentSection+" - Question "+(index+1);

let html=q.q||"";
if(q.svg) html+=`<div class="diagram">${q.svg}</div>`;
question.innerHTML=html;

if(q.options){
options.innerHTML=q.options.map((op,i)=>`
<label class="option">
<input type="radio" ${q.answer===i?"checked":""}
onchange="selectOption(${i})">
${op}</label>`).join("");
}else{
options.innerHTML=`<input class="numInput" type="number"
value="${q.answer??''}" oninput="setNumerical(this.value)">`;
}

updatePalette();
MathJax.typesetPromise();
}

function selectOption(i){
sections[currentSection][index].answer=i;
updatePalette();
}

function setNumerical(v){
sections[currentSection][index].answer=v===""?null:parseFloat(v);
updatePalette();
}

function nextQ(){if(index<sections[currentSection].length-1){index++;render();}}
function prevQ(){if(index>0){index--;render();}}

function updatePalette(){
palette.innerHTML=sections[currentSection].map((q,i)=>{
let cls="notVisited";
if(q.answer!==null) cls="answered";
if(i===index) cls+=" current";
return `<button class="${cls}" onclick="gotoQ(${i})">${i+1}</button>`;
}).join("");
}

function gotoQ(i){index=i;render();}

/* ===== TIMER ===== */

function startTimer(){
setInterval(()=>{
totalTime--;
let m=Math.floor(totalTime/60);
let s=totalTime%60;
time.innerText=String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');

if(totalTime<=0){
alert("Time Up! Submitting...");
submitExam(true);
}
},1000);
}

/* ===== CONFIRM SUBMIT ===== */

function submitExam(auto=false){

let unanswered=0;
Object.values(sections).forEach(arr=>{
arr.forEach(q=>{if(q.answer===null)unanswered++;});
});

if(!auto){
if(!confirm("You still have "+unanswered+" unanswered questions.\nSubmit anyway?")) return;
}

localStorage.setItem("exam_result",JSON.stringify(examData));
location.href="score.html";
}

</script>
</body>
</html>
