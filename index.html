<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional CBT Portal</title>
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary: #004ba0; --success: #2e7d32; --danger: #c62828; 
            --review: #6a1b9a; --bg: #f0f2f5; --text: #333;
        }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Instruction Page (Mobile Responsive) --- */
        #instPage { position: fixed; inset: 0; background: #fff; z-index: 1000; overflow-y: auto; display: flex; flex-direction: column; }
        .inst-header { background: var(--primary); color: white; padding: 15px; font-weight: bold; font-size: 1.1rem; }
        .inst-container { display: flex; flex: 1; flex-direction: row; }
        .inst-content { flex: 1; padding: 20px; overflow-y: auto; border-right: 1px solid #ddd; }
        .inst-sidebar { width: 320px; background: #f8f9fa; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        .data-badge { display: inline-block; background: #e3f2fd; padding: 10px 15px; border-radius: 5px; margin: 5px; border: 1px solid #bbdefb; font-size: 0.9rem; }
        
        /* --- Exam Layout --- */
        .header { height: 60px; background: #fff; border-bottom: 2px solid var(--primary); display: none; justify-content: space-between; align-items: center; padding: 0 15px; z-index: 10; }
        .main { display: none; flex: 1; overflow: hidden; }
        .left-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .right-panel { width: 300px; background: #fff; border-left: 1px solid #ccc; display: flex; flex-direction: column; transition: 0.3s; }
        
        .section-bar { display: flex; background: #e0e0e0; overflow-x: auto; scrollbar-width: none; }
        .sec-btn { padding: 12px 20px; border: none; cursor: pointer; white-space: nowrap; font-weight: 600; background: #d0d0d0; transition: 0.2s; }
        .sec-btn.active { background: var(--primary); color: white; }

        .q-container { flex: 1; padding: 20px; overflow-y: auto; background: #fff; }
        .palette-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 8px; padding: 15px; overflow-y: auto; }
        
        /* JEE Shapes */
        .pal-btn { height: 40px; border: 1px solid #999; background: #fff; cursor: pointer; font-size: 0.85rem; }
        .pal-ans { background: var(--success) !important; color: white; border-radius: 15px 15px 0 0; }
        .pal-notans { background: var(--danger) !important; color: white; border-radius: 0 0 15px 15px; }
        .pal-rev { background: var(--review) !important; color: white; border-radius: 50%; }
        .pal-active { outline: 3px solid #000; outline-offset: -2px; }

        .footer { padding: 10px; background: #f5f5f5; border-top: 1px solid #ddd; display: flex; justify-content: space-between; gap: 10px; }
        .btn { padding: 10px 15px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
        
        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .inst-container { flex-direction: column; }
            .inst-sidebar { width: 100%; border-top: 1px solid #ddd; }
            .right-panel { display: none; } /* Palette hidden by default on mobile */
            .right-panel.open { display: flex; position: fixed; right: 0; top: 60px; bottom: 60px; z-index: 100; box-shadow: -2px 0 10px rgba(0,0,0,0.2); }
            .btn-mobile-pal { display: block !important; }
        }
    </style>
</head>
<body>

<div id="instPage">
    <div class="inst-header">Examination Instructions</div>
    <div class="inst-container">
        <div class="inst-content">
            <h3>General Information</h3>
            <p>Select a paper on the right to load dynamic exam details.</p>
            <div id="dynamicStats"></div>
            <hr>
            <h4>Navigation Symbols:</h4>
            <p><b>Square (White):</b> Not Visited<br>
            <b>Rounded Bottom (Red):</b> Not Answered<br>
            <b>Rounded Top (Green):</b> Answered<br>
            <b>Circle (Purple):</b> Marked for Review</p>
        </div>
        <div class="inst-sidebar">
            <div style="width:100px; height:120px; background:#ddd; border:1px solid #999; margin-bottom:15px; display:flex; align-items:center; justify-content:center;">PHOTO</div>
            <select id="paperSelect" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid var(--primary);"></select>
            <label style="font-size: 0.85rem; cursor:pointer;">
                <input type="checkbox" id="confirmCheck"> I am ready to begin the exam.
            </label>
            <button id="startBtn" class="btn" style="width:100%; margin-top:20px; background:var(--success); color:white; border:none; padding:15px;">START EXAM</button>
        </div>
    </div>
</div>

<header class="header" id="header">
    <div id="activePaper" style="font-weight:bold;">CBT</div>
    <button class="btn btn-mobile-pal" style="display:none;" onclick="togglePalette()">Questions</button>
    <div id="timer" style="background:#222; color:#fff; padding:5px 12px; font-weight:bold; border-radius:3px;">00:00:00</div>
</header>

<main class="main" id="main">
    <div class="left-panel">
        <div class="section-bar" id="secBar"></div>
        <div class="q-container" id="qArea"></div>
        <footer class="footer">
            <button class="btn" style="background:var(--review); color:white;" onclick="processAction('mark')">Review</button>
            <button class="btn" onclick="processAction('clear')">Clear</button>
            <button class="btn" style="background:var(--primary); color:white;" onclick="processAction('save')">Save & Next</button>
        </footer>
    </div>
    <div class="right-panel" id="sidePanel">
        <div class="palette-grid" id="palette"></div>
        <div style="padding:15px; margin-top:auto;">
            <button class="btn" style="width:100%; background:var(--success); color:white;" onclick="finishExam()">Submit</button>
        </div>
    </div>
</main>

<script>
    let exam = { data: null, sections: null, curSec: '', curIdx: 0, lastIdx: {}, time: 0 };

    window.onload = () => {
        const papers = ["paper-1.json", "JEE FE-1.json"];
        const ps = document.getElementById('paperSelect');
        ps.innerHTML = `<option disabled selected>-- Select Question Paper --</option>` + 
                       papers.map(p => `<option value="${p}">${p}</option>`).join('');
        
        ps.onchange = async (e) => {
            exam.data = await fetch(e.target.value).then(r => r.json());
            const s = exam.data.sections;
            let totalQ = 0;
            Object.values(s).forEach(sec => totalQ += sec.length);
            const maxM = totalQ * (exam.data.marking?.correct || 4);

            document.getElementById('dynamicStats').innerHTML = `
                <div class="data-badge"><b>Duration:</b> ${exam.data.duration} Mins</div>
                <div class="data-badge"><b>Total Questions:</b> ${totalQ}</div>
                <div class="data-badge"><b>Max Marks:</b> ${maxM}</div>
                <div class="data-badge"><b>Marking:</b> +${exam.data.marking?.correct || 4}, -${Math.abs(exam.data.marking?.wrong || 1)}</div>
            `;
        };

        document.getElementById('startBtn').onclick = () => {
            if(!exam.data || !document.getElementById('confirmCheck').checked) return alert("Select paper & confirm!");
            initExam();
        };
    };

    function initExam() {
        exam.sections = exam.data.sections;
        exam.curSec = Object.keys(exam.sections)[0];
        exam.time = (exam.data.duration || 180) * 60;
        Object.keys(exam.sections).forEach(s => {
            exam.sections[s] = exam.sections[s].map(q => ({...q, ans: null, state: 0}));
            exam.lastIdx[s] = 0;
        });

        document.getElementById('instPage').style.display = 'none';
        document.getElementById('header').style.display = 'flex';
        document.getElementById('main').style.display = 'flex';
        renderTabs(); renderQ(); startTimer();
    }

    function renderTabs() {
        document.getElementById('secBar').innerHTML = Object.keys(exam.sections).map(s => {
            const count = exam.sections[s].filter(q => q.ans !== null).length;
            return `<button class="sec-btn ${s===exam.curSec?'active':''}" onclick="changeSec('${s}')">${s} (${count})</button>`;
        }).join('');
    }

    function changeSec(s) {
        exam.lastIdx[exam.curSec] = exam.curIdx;
        exam.curSec = s;
        exam.curIdx = exam.lastIdx[s];
        renderTabs(); renderQ();
    }

    function renderQ() {
        const q = exam.sections[exam.curSec][exam.curIdx];
        if(q.state === 0) q.state = 2; // Visited but not answered

        let html = `<h4>Question ${exam.curIdx + 1}</h4><div>${q.q}</div>`;
        if(q.svg) html += `<div style="margin:20px 0;">${q.svg}</div>`;
        
        html += `<div style="margin-top:20px;">`;
        if(q.options) {
            html += q.options.map((o, i) => `
                <label style="display:block; padding:10px; border:1px solid #ddd; margin-bottom:8px; border-radius:4px; cursor:pointer;">
                    <input type="radio" name="opt" ${q.ans===i?'checked':''} onclick="setAns(${i})"> ${o}
                </label>`).join('');
        } else {
            html += `<input type="number" class="btn" style="width:100%; max-width:200px;" value="${q.ans||''}" oninput="setAns(this.value)">`;
        }
        
        document.getElementById('qArea').innerHTML = html;
        MathJax.typesetPromise();
        renderPalette();
    }

    function setAns(v) { exam.sections[exam.curSec][exam.curIdx].ans = v; renderTabs(); }

    function renderPalette() {
        document.getElementById('palette').innerHTML = exam.sections[exam.curSec].map((q, i) => {
            let cls = '';
            if(q.ans !== null) cls = 'pal-ans'; else if(q.state === 2) cls = 'pal-notans';
            if(q.state === 3) cls = 'pal-rev';
            return `<button class="pal-btn ${cls} ${i===exam.curIdx?'pal-active':''}" onclick="exam.curIdx=${i};renderQ()">${i+1}</button>`;
        }).join('');
    }

    function processAction(type) {
        const q = exam.sections[exam.curSec][exam.curIdx];
        if(type === 'clear') { q.ans = null; q.state = 2; }
        else if(type === 'mark') q.state = 3;
        else if(type === 'save') q.state = 1;

        if(exam.curIdx < exam.sections[exam.curSec].length - 1) exam.curIdx++;
        renderTabs(); renderQ();
    }

    function startTimer() {
        setInterval(() => {
            exam.time--;
            const h = Math.floor(exam.time/3600), m = Math.floor((exam.time%3600)/60), s = exam.time%60;
            document.getElementById('timer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            if(exam.time <= 0) finishExam();
        }, 1000);
    }

    function togglePalette() { document.getElementById('sidePanel').classList.toggle('open'); }

    function finishExam() {
        localStorage.setItem("exam_result", JSON.stringify(exam.data));
        window.location.href = "score.html";
    }
</script>
</body>
</html>
